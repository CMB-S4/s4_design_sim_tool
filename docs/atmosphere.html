---
toc: True
title: Atmosphere

keywords: fastai
sidebar: home_sidebar

summary: "Load and scale the maps of the noise from the atmosphere"
description: "Load and scale the maps of the noise from the atmosphere"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 02_atmosphere.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">toml</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">toml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;s4_reference_design.toml&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">log</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_telecope_years</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the number of telescope/years in the CMB-S4 configuration</span>

<span class="sd">    config_telescopes : dict</span>
<span class="sd">        CMB-S4 telescopes configuration,</span>
<span class="sd">        generally loaded from a TOML file</span>
<span class="sd">    site : str</span>
<span class="sd">        &#39;Pole&#39; or &#39;Chile&#39;, case doesn&#39;t matter</span>
<span class="sd">    channel : str</span>
<span class="sd">        Channel tag, e.g. &#39;MFHS1&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">telescope_years</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">tube</span><span class="p">,</span> <span class="n">bands</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;telescopes&quot;</span><span class="p">][</span><span class="n">get_telescope</span><span class="p">(</span><span class="n">channel</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">bands</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">site</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">has_band</span> <span class="o">=</span> <span class="n">bands</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">channel</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">telescope_years</span> <span class="o">+=</span> <span class="n">has_band</span> <span class="o">*</span> <span class="n">bands</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;years&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">][</span><span class="s2">&quot;total_experiment_length_years&quot;</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">telescope_years</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_telecope_years" class="doc_header"><code>get_telecope_years</code><a href="https://github.com/cmb-s4/s4_design_sim_tool/tree/master/s4_design_sim_tool/atmosphere.py#L17" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_telecope_years</code>(<strong><code>config</code></strong>, <strong><code>site</code></strong>, <strong><code>channel</code></strong>)</p>
</blockquote>

<pre><code>Compute the number of telescope/years in the CMB-S4 configuration

config_telescopes : dict
    CMB-S4 telescopes configuration,
    generally loaded from a TOML file
site : str
    'Pole' or 'Chile', case doesn't matter
channel : str
    Channel tag, e.g. 'MFHS1'</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">s4</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s2">&quot;cmbs4_tophat.h5&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>tail -30 s4_reference_design.toml
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[telescopes]

    # Telescope names are not used within the software

    [telescopes.SAT]
    # Available SAT tubes (band centers in GHz) are:
    # LFS (30,40), MFLS (85,145.1), MFHS (95,155.1), HFS (220,270)
    # Tubes for each SAT should be 3

    SAT1 = { LFS=0, MFLS= 3, MFHS=0, HFS=0, site=&#34;Pole&#34;, years=7 }
    SAT3 = { LFS=0, MFLS= 0, MFHS=3, HFS=0, site=&#34;Pole&#34;, years=7 }
    SAT5 = { LFS=1, MFLS= 0, MFHS=0, HFS=2, site=&#34;Pole&#34;, years=7 }

    SAT0 = { LFS=0, MFLS= 3, MFHS=0, HFS=0, site=&#34;Pole&#34;, years=7 }
    SAT2 = { LFS=0, MFLS= 0, MFHS=3, HFS=0, site=&#34;Pole&#34;, years=7 }
    SAT4 = { LFS=1, MFLS= 0, MFHS=0, HFS=2, site=&#34;Pole&#34;, years=7 }

    [telescopes.LAT]
    # Available LAT tubes (band centers in GHz) are:
    # ULFL (20), LFL (27,39), MFL (93,145), HFL (225,278)
    # Tubes for each LAT should be 19

    # Legacy survey LAT deployed in Chile

    LAT0 = { ULFL=0, LFL= 2, MFL=12, HFL=5, site=&#34;Chile&#34;, years=7 }
    LAT1 = { ULFL=0, LFL= 2, MFL=12, HFL=5, site=&#34;Chile&#34;, years=7 }

    # Delensing survey LAT deployed at Pole

    LAT2 = { ULFL=1, LFL= 2, MFL=11, HFL=4, site=&#34;Pole&#34;, years=7 }
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Compute-telescope/years-for-the-reference-design">Compute telescope/years for the reference design<a class="anchor-link" href="#Compute-telescope/years-for-the-reference-design"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Pole&quot;</span><span class="p">,</span> <span class="s2">&quot;Chile&quot;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">s4</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">telescope_years</span> <span class="o">=</span> <span class="n">get_telecope_years</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">telescope_years</span><span class="p">)</span>
        <span class="n">telescope</span> <span class="o">=</span> <span class="n">get_telescope</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="s2">&quot;Chile&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s2">&quot;SAT&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">telescope_years</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;All SAT at Pole&quot;</span>
            <span class="k">elif</span> <span class="n">channel</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ULFL&quot;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">telescope_years</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No ULFL in Chile&quot;</span>              
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">telescope_years</span> <span class="o">==</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;2 LAT each band&quot;</span>
        <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="s2">&quot;Pole&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s2">&quot;SAT&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">telescope_years</span> <span class="o">==</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;2 SAT telescopes each band&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">telescope_years</span> <span class="o">==</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;1 LAT with all 4 bands&quot;</span> 
    <span class="nb">print</span><span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Pole HFL1 7
Pole HFL2 7
Pole HFS1 14
Pole HFS2 14
Pole LFL1 7
Pole LFL2 7
Pole LFS1 14
Pole LFS2 14
Pole MFHS1 14
Pole MFHS2 14
Pole MFL1 7
Pole MFL2 7
Pole MFLS1 14
Pole MFLS2 14
Pole ULFL1 7
==============================
Chile HFL1 14
Chile HFL2 14
Chile HFS1 0
Chile HFS2 0
Chile LFL1 14
Chile LFL2 14
Chile LFS1 0
Chile LFS2 0
Chile MFHS1 0
Chile MFHS2 0
Chile MFL1 14
Chile MFL2 14
Chile MFLS1 0
Chile MFLS2 0
Chile ULFL1 0
==============================
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">load_atmosphere</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">realization</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load foreground maps for a channel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : dict</span>
<span class="sd">        CMB-S4 configuration,</span>
<span class="sd">        generally loaded from a TOML file</span>
<span class="sd">    site : str</span>
<span class="sd">        &#39;Pole&#39; or &#39;Chile&#39;, case doesn&#39;t matter</span>
<span class="sd">    channel : str</span>
<span class="sd">        Channel tag, e.g. &#39;MFHS1&#39;</span>
<span class="sd">    realization : int</span>
<span class="sd">        Choose one of the available 8 realizations</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output_map : numpy array</span>
<span class="sd">        Output map with all emissions combined, uses nan for missing pixels</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">telescope</span> <span class="o">=</span> <span class="n">get_telescope</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
    <span class="n">map_filename</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{realization:08d}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="o">/</span> <span class="n">f</span><span class="s2">&quot;{site.lower()}_atmosphere_</span><span class="si">{telescope}</span><span class="s2">_</span><span class="si">{channel}</span><span class="s2">_filtered_telescope_all_time_all_bmap.fits&quot;</span>
    <span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Reading </span><span class="si">{map_filename}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">atmosphere_map</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">read_map</span><span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">base_folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">map_filename</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">atmosphere_map</span><span class="p">[</span><span class="n">atmosphere_map</span> <span class="o">==</span> <span class="n">hp</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># input map is 10 days at 100% efficiency</span>
    <span class="n">atmosphere_map</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="mf">365.25</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">][</span><span class="s2">&quot;observing_efficiency&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># pole sims have lower efficiency</span>
    <span class="n">atmosphere_map</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">simulations_observing_efficiency</span><span class="p">[</span><span class="n">site</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">telescope</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">atmosphere_map</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">get_telecope_years</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">atmosphere_map</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_atmosphere" class="doc_header"><code>load_atmosphere</code><a href="https://github.com/cmb-s4/s4_design_sim_tool/tree/master/s4_design_sim_tool/atmosphere.py#L40" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_atmosphere</code>(<strong><code>config</code></strong>, <strong><code>site</code></strong>, <strong><code>channel</code></strong>, <strong><code>realization</code></strong>=<em><code>0</code></em>)</p>
</blockquote>

<pre><code>Load foreground maps for a channel

Parameters
----------
config : dict
    CMB-S4 configuration,
    generally loaded from a TOML file
site : str
    'Pole' or 'Chile', case doesn't matter
channel : str
    Channel tag, e.g. 'MFHS1'
realization : int
    Choose one of the available 8 realizations

Returns
-------
output_map : numpy array
    Output map with all emissions combined, uses nan for missing pixels</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Run-on-a-channel-and-plot-results">Run on a channel and plot results<a class="anchor-link" href="#Run-on-a-channel-and-plot-results"> </a></h2><p>Available atmosphere maps</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">filenames</span> <span class="o">=</span> <span class="o">!</span>ls /global/cscratch1/sd/keskital/s4sim/reference_tool/out/00000000/*atmo*
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os.path</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>chile_atmosphere_LAT_HFL1_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_LAT_HFL2_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_LAT_LFL1_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_LAT_LFL2_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_LAT_MFL1_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_SAT_LFS1_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_SAT_LFS2_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_SAT_MFHS1_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_SAT_MFHS2_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_SAT_MFLS1_filtered_telescope_all_time_all_bmap.fits
chile_atmosphere_SAT_MFLS2_filtered_telescope_all_time_all_bmap.fits
pole_atmosphere_LAT_HFL1_filtered_telescope_all_time_all_bmap.fits
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">channel</span> <span class="o">=</span> <span class="s2">&quot;LFS1&quot;</span>
<span class="n">site</span> <span class="o">=</span> <span class="s2">&quot;Pole&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">output_map</span> <span class="o">=</span> <span class="n">load_atmosphere</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">realization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>INFO:root:Reading 00000000/pole_atmosphere_SAT_LFS1_filtered_telescope_all_time_all_bmap.fits
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-14-babba653a5d2&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>output_map <span class="ansi-blue-fg">=</span> load_atmosphere<span class="ansi-blue-fg">(</span>config<span class="ansi-blue-fg">,</span> site<span class="ansi-blue-fg">,</span> channel<span class="ansi-blue-fg">,</span> realization<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">&lt;ipython-input-10-75188339d476&gt;</span> in <span class="ansi-cyan-fg">load_atmosphere</span><span class="ansi-blue-fg">(config, site, channel, realization)</span>
<span class="ansi-green-intense-fg ansi-bold">     30</span>     log<span class="ansi-blue-fg">.</span>info<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#34;Reading {map_filename}&#34;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     31</span>     atmosphere_map = hp.read_map(
<span class="ansi-green-fg">---&gt; 32</span><span class="ansi-red-fg">         </span>Path<span class="ansi-blue-fg">(</span>base_folder<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">/</span> map_filename<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> dtype<span class="ansi-blue-fg">=</span>np<span class="ansi-blue-fg">.</span>float32<span class="ansi-blue-fg">,</span> verbose<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span>
<span class="ansi-green-intense-fg ansi-bold">     33</span>     )
<span class="ansi-green-intense-fg ansi-bold">     34</span>     atmosphere_map<span class="ansi-blue-fg">[</span>atmosphere_map <span class="ansi-blue-fg">==</span> hp<span class="ansi-blue-fg">.</span>UNSEEN<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>nan

<span class="ansi-green-fg">~/condajupynersc/lib/python3.6/site-packages/healpy/fitsfunc.py</span> in <span class="ansi-cyan-fg">read_map</span><span class="ansi-blue-fg">(filename, field, dtype, nest, partial, hdu, h, verbose, memmap)</span>
<span class="ansi-green-intense-fg ansi-bold">    356</span>             &#34;important to you.&#34;)
<span class="ansi-green-intense-fg ansi-bold">    357</span> 
<span class="ansi-green-fg">--&gt; 358</span><span class="ansi-red-fg">     </span>fits_hdu <span class="ansi-blue-fg">=</span> _get_hdu<span class="ansi-blue-fg">(</span>filename<span class="ansi-blue-fg">,</span> hdu<span class="ansi-blue-fg">=</span>hdu<span class="ansi-blue-fg">,</span> memmap<span class="ansi-blue-fg">=</span>memmap<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    359</span> 
<span class="ansi-green-intense-fg ansi-bold">    360</span>     nside <span class="ansi-blue-fg">=</span> fits_hdu<span class="ansi-blue-fg">.</span>header<span class="ansi-blue-fg">.</span>get<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;NSIDE&#34;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/condajupynersc/lib/python3.6/site-packages/healpy/fitsfunc.py</span> in <span class="ansi-cyan-fg">_get_hdu</span><span class="ansi-blue-fg">(input_data, hdu, memmap)</span>
<span class="ansi-green-intense-fg ansi-bold">    655</span> 
<span class="ansi-green-intense-fg ansi-bold">    656</span>     <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>input_data<span class="ansi-blue-fg">,</span> allowed_paths<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 657</span><span class="ansi-red-fg">         </span>hdulist <span class="ansi-blue-fg">=</span> pf<span class="ansi-blue-fg">.</span>open<span class="ansi-blue-fg">(</span>input_data<span class="ansi-blue-fg">,</span> memmap<span class="ansi-blue-fg">=</span>memmap<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    658</span>         <span class="ansi-green-fg">return</span> _get_hdu<span class="ansi-blue-fg">(</span>hdulist<span class="ansi-blue-fg">,</span> hdu<span class="ansi-blue-fg">=</span>hdu<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    659</span> 

<span class="ansi-green-fg">~/condajupynersc/lib/python3.6/site-packages/astropy/io/fits/hdu/hdulist.py</span> in <span class="ansi-cyan-fg">fitsopen</span><span class="ansi-blue-fg">(name, mode, memmap, save_backup, cache, lazy_load_hdus, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    156</span> 
<span class="ansi-green-intense-fg ansi-bold">    157</span>     return HDUList.fromfile(name, mode, memmap, save_backup, cache,
<span class="ansi-green-fg">--&gt; 158</span><span class="ansi-red-fg">                             lazy_load_hdus, **kwargs)
</span><span class="ansi-green-intense-fg ansi-bold">    159</span> 
<span class="ansi-green-intense-fg ansi-bold">    160</span> 

<span class="ansi-green-fg">~/condajupynersc/lib/python3.6/site-packages/astropy/io/fits/hdu/hdulist.py</span> in <span class="ansi-cyan-fg">fromfile</span><span class="ansi-blue-fg">(cls, fileobj, mode, memmap, save_backup, cache, lazy_load_hdus, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    395</span>         return cls._readfrom(fileobj=fileobj, mode=mode, memmap=memmap,
<span class="ansi-green-intense-fg ansi-bold">    396</span>                              save_backup<span class="ansi-blue-fg">=</span>save_backup<span class="ansi-blue-fg">,</span> cache<span class="ansi-blue-fg">=</span>cache<span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">--&gt; 397</span><span class="ansi-red-fg">                              lazy_load_hdus=lazy_load_hdus, **kwargs)
</span><span class="ansi-green-intense-fg ansi-bold">    398</span> 
<span class="ansi-green-intense-fg ansi-bold">    399</span>     <span class="ansi-blue-fg">@</span>classmethod

<span class="ansi-green-fg">~/condajupynersc/lib/python3.6/site-packages/astropy/io/fits/hdu/hdulist.py</span> in <span class="ansi-cyan-fg">_readfrom</span><span class="ansi-blue-fg">(cls, fileobj, data, mode, memmap, save_backup, cache, lazy_load_hdus, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">   1044</span>             <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> isinstance<span class="ansi-blue-fg">(</span>fileobj<span class="ansi-blue-fg">,</span> _File<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1045</span>                 <span class="ansi-red-fg"># instantiate a FITS file object (ffo)</span>
<span class="ansi-green-fg">-&gt; 1046</span><span class="ansi-red-fg">                 </span>fileobj <span class="ansi-blue-fg">=</span> _File<span class="ansi-blue-fg">(</span>fileobj<span class="ansi-blue-fg">,</span> mode<span class="ansi-blue-fg">=</span>mode<span class="ansi-blue-fg">,</span> memmap<span class="ansi-blue-fg">=</span>memmap<span class="ansi-blue-fg">,</span> cache<span class="ansi-blue-fg">=</span>cache<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1047</span>             <span class="ansi-red-fg"># The Astropy mode is determined by the _File initializer if the</span>
<span class="ansi-green-intense-fg ansi-bold">   1048</span>             <span class="ansi-red-fg"># supplied mode was None</span>

<span class="ansi-green-fg">~/condajupynersc/lib/python3.6/site-packages/astropy/utils/decorators.py</span> in <span class="ansi-cyan-fg">wrapper</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    519</span>                             kwargs<span class="ansi-blue-fg">[</span>new_name<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> value
<span class="ansi-green-intense-fg ansi-bold">    520</span> 
<span class="ansi-green-fg">--&gt; 521</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">return</span> function<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    522</span> 
<span class="ansi-green-intense-fg ansi-bold">    523</span>         <span class="ansi-green-fg">return</span> wrapper

<span class="ansi-green-fg">~/condajupynersc/lib/python3.6/site-packages/astropy/io/fits/file.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, fileobj, mode, memmap, overwrite, cache)</span>
<span class="ansi-green-intense-fg ansi-bold">    191</span>             self<span class="ansi-blue-fg">.</span>_open_fileobj<span class="ansi-blue-fg">(</span>fileobj<span class="ansi-blue-fg">,</span> mode<span class="ansi-blue-fg">,</span> overwrite<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    192</span>         <span class="ansi-green-fg">elif</span> isinstance<span class="ansi-blue-fg">(</span>fileobj<span class="ansi-blue-fg">,</span> str<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 193</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_open_filename<span class="ansi-blue-fg">(</span>fileobj<span class="ansi-blue-fg">,</span> mode<span class="ansi-blue-fg">,</span> overwrite<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    194</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    195</span>             self<span class="ansi-blue-fg">.</span>_open_filelike<span class="ansi-blue-fg">(</span>fileobj<span class="ansi-blue-fg">,</span> mode<span class="ansi-blue-fg">,</span> overwrite<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/condajupynersc/lib/python3.6/site-packages/astropy/io/fits/file.py</span> in <span class="ansi-cyan-fg">_open_filename</span><span class="ansi-blue-fg">(self, filename, mode, overwrite)</span>
<span class="ansi-green-intense-fg ansi-bold">    572</span> 
<span class="ansi-green-intense-fg ansi-bold">    573</span>         <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>_try_read_compressed<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>name<span class="ansi-blue-fg">,</span> magic<span class="ansi-blue-fg">,</span> mode<span class="ansi-blue-fg">,</span> ext<span class="ansi-blue-fg">=</span>ext<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 574</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_file <span class="ansi-blue-fg">=</span> fileobj_open<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>name<span class="ansi-blue-fg">,</span> IO_FITS_MODES<span class="ansi-blue-fg">[</span>mode<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    575</span>             self<span class="ansi-blue-fg">.</span>close_on_error <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span>
<span class="ansi-green-intense-fg ansi-bold">    576</span> 

<span class="ansi-green-fg">~/condajupynersc/lib/python3.6/site-packages/astropy/io/fits/util.py</span> in <span class="ansi-cyan-fg">fileobj_open</span><span class="ansi-blue-fg">(filename, mode)</span>
<span class="ansi-green-intense-fg ansi-bold">    394</span>     &#34;&#34;&#34;
<span class="ansi-green-intense-fg ansi-bold">    395</span> 
<span class="ansi-green-fg">--&gt; 396</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> open<span class="ansi-blue-fg">(</span>filename<span class="ansi-blue-fg">,</span> mode<span class="ansi-blue-fg">,</span> buffering<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    397</span> 
<span class="ansi-green-intense-fg ansi-bold">    398</span> 

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;/global/cscratch1/sd/keskital/s4sim/reference_tool/out/00000000/pole_atmosphere_SAT_LFS1_filtered_telescope_all_time_all_bmap.fits&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">output_map</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">output_map</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">output_map</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">output_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">,</span> \
    <span class="s2">&quot;Amplitude check failed&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">output_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-4</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">output_map</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">,</span> \
    <span class="s2">&quot;Amplitude check failed&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1e-5</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Atmosphere I&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are no systematics in the half-wave plate or bandpass mismatch, so almost all the atmosphere signal is rejected in polarization.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1e-9</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Atmosphere Q&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1e-9</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Atmosphere U&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

