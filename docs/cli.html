---

title: Simulation interface


keywords: fastai
sidebar: home_sidebar

summary: "Main simulation class and command line client"
description: "Main simulation class and command line client"
nb_path: "05_cli.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 05_cli.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5sum_string" class="doc_header"><code>md5sum_string</code><a href="https://github.com/cmb-s4/s4_design_sim_tool/tree/master/s4_design_sim_tool/cli.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5sum_string</code>(<strong><code>string</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="md5sum_file" class="doc_header"><code>md5sum_file</code><a href="https://github.com/cmb-s4/s4_design_sim_tool/tree/master/s4_design_sim_tool/cli.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>md5sum_file</code>(<strong><code>filename</code></strong>)</p>
</blockquote>

<pre><code>Compute md5 checksum of the contents of a file</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">hashlib</span>


<span class="k">def</span> <span class="nf">md5sum_string</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">md5sum_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute md5 checksum of the contents of a file&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">md5sum_string</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">console_md5sum</span> <span class="o">=</span> <span class="o">!</span>md5sum s4_reference_design.toml
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">md5sum_file</span><span class="p">(</span><span class="s2">&quot;s4_reference_design.toml&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">console_md5sum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AssertionError</span>                            Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-6-23ddc48fd409&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">assert</span> md5sum_file<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;s4_reference_design.toml&#34;</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">==</span> console_md5sum<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>split<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>

<span class="ansi-red-fg">AssertionError</span>: </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="S4RefSimTool" class="doc_header"><code>class</code> <code>S4RefSimTool</code><a href="https://github.com/cmb-s4/s4_design_sim_tool/tree/master/s4_design_sim_tool/cli.py#L41" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>S4RefSimTool</code>(<strong><code>config_filename</code></strong>, <strong><code>output_folder</code></strong>=<em><code>'output'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">S4RefSimTool</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate CMB-S4 maps based on the experiment configuration</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config : filename</span>
<span class="sd">            CMB-S4 configuration stored in a TOML file</span>
<span class="sd">            see for example s4_reference_design.toml in the repository</span>
<span class="sd">        output_folder : str or Path</span>
<span class="sd">            Output path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span> <span class="o">=</span> <span class="n">config_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">toml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_filename_template</span> <span class="o">=</span> <span class="s2">&quot;cmbs4_KCMB_</span><span class="si">{telescope}</span><span class="s2">-</span><span class="si">{band}</span><span class="s2">_</span><span class="si">{site}</span><span class="s2">_nside</span><span class="si">{nside}</span><span class="s2">_</span><span class="si">{split}</span><span class="s2">_of_</span><span class="si">{nsplits}</span><span class="s2">.fits&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">sites</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Pole&quot;</span><span class="p">,</span> <span class="s2">&quot;Chile&quot;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Run the simulation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        channels : str or list[str]</span>
<span class="sd">            list of channel tags, e.g.</span>
<span class="sd">            * [&quot;LFS1&quot;, &quot;LFS2&quot;] or</span>
<span class="sd">            * &quot;SAT&quot; or &quot;LAT&quot;</span>
<span class="sd">            * &quot;all&quot; (default)</span>
<span class="sd">        site : list[str]</span>
<span class="sd">            [&#39;Pole&#39;] or [&#39;Chile&#39;], by default [&quot;Pole&quot;, &quot;Chile&quot;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nsplits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number_of_splits&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nsplits</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nsplits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">nsplits</span> <span class="o">&lt;</span> <span class="mi">8</span>
        <span class="p">),</span> <span class="s2">&quot;We currently only have 7 independent realizations of atmosphere and noise&quot;</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">parse_channels</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">get_telecope_years</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">telescope</span> <span class="o">=</span> <span class="n">get_telescope</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
                <span class="n">subfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">telescope</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">site</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">subfolder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created output folder </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">subfolder</span><span class="p">))</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulate channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sky_emission</span> <span class="o">=</span> <span class="n">load_sky_emission</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sky_emission&quot;</span><span class="p">],</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsplits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">nside</span> <span class="o">=</span> <span class="mi">512</span> <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s2">&quot;SAT&quot;</span> <span class="k">else</span> <span class="mi">4096</span>
                    <span class="n">output_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_filename_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nside</span><span class="o">=</span><span class="n">nside</span><span class="p">,</span>
                        <span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">,</span>
                        <span class="n">band</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                        <span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                        <span class="n">split</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">split</span><span class="p">),</span>  <span class="c1"># split=0 is full mission and we want 1</span>
                        <span class="n">nsplits</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">nsplits</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">/</span> <span class="n">output_filename</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> already exists, SKIP&quot;</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">output_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sky_emission</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_atmosphere&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                        <span class="n">output_map</span> <span class="o">+=</span> <span class="n">load_atmosphere</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">realization</span><span class="o">=</span><span class="n">split</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skip the atmosphere noise&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_noise&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                        <span class="n">output_map</span> <span class="o">+=</span> <span class="n">load_noise</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">realization</span><span class="o">=</span><span class="n">split</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skip the instrument noise&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">split</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">output_map</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nsplits</span><span class="p">)</span>
                    <span class="n">output_map</span> <span class="o">+=</span> <span class="n">sky_emission</span>
                    <span class="c1"># Use UNSEEN instead of nan for missing pixels</span>
                    <span class="n">output_map</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">output_map</span><span class="p">)]</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">UNSEEN</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">noise_version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>
                    <span class="n">hp</span><span class="o">.</span><span class="n">write_map</span><span class="p">(</span>
                        <span class="n">subfolder</span> <span class="o">/</span> <span class="n">output_filename</span><span class="p">,</span>
                        <span class="n">output_map</span><span class="p">,</span>
                        <span class="n">column_units</span><span class="o">=</span><span class="s2">&quot;K_CMB&quot;</span><span class="p">,</span>
                        <span class="n">extra_header</span><span class="o">=</span><span class="p">[</span>
                            <span class="p">(</span><span class="s2">&quot;SOFTWARE&quot;</span><span class="p">,</span> <span class="s2">&quot;s4_design_sim_tool&quot;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;SW_VERS&quot;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;SKY_VERS&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;ATM_VERS&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;NOI_VERS&quot;</span><span class="p">,</span> <span class="n">noise_version</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;SITE&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;SPLIT&quot;</span><span class="p">,</span> <span class="n">split</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;NSPLITS&quot;</span><span class="p">,</span> <span class="n">nsplits</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;CHANNEL&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())),</span>
                            <span class="p">(</span><span class="s2">&quot;CONFMD5&quot;</span><span class="p">,</span> <span class="n">md5sum_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span><span class="p">)),</span>
                        <span class="p">],</span>
                        <span class="n">coord</span><span class="o">=</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># only run of full mission and the first split</span>
                    <span class="k">if</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_noise&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Loading hitmap and white noise covariance matrix&quot;</span>
                            <span class="p">)</span>
                            <span class="n">hitmap</span><span class="p">,</span> <span class="n">wcov</span> <span class="o">=</span> <span class="n">load_hitmap_wcov</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">realization</span><span class="o">=</span><span class="mi">0</span>
                            <span class="p">)</span>
                        <span class="n">hitmap_filename</span> <span class="o">=</span> <span class="n">output_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;KCMB&quot;</span><span class="p">,</span> <span class="s2">&quot;hitmap&quot;</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing </span><span class="si">{</span><span class="n">hitmap_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">hp</span><span class="o">.</span><span class="n">write_map</span><span class="p">(</span>
                            <span class="n">subfolder</span> <span class="o">/</span> <span class="n">hitmap_filename</span><span class="p">,</span>
                            <span class="n">hitmap</span><span class="p">,</span>
                            <span class="n">column_units</span><span class="o">=</span><span class="s2">&quot;hits&quot;</span><span class="p">,</span>
                            <span class="n">extra_header</span><span class="o">=</span><span class="p">[</span>
                                <span class="p">(</span><span class="s2">&quot;SOFTWARE&quot;</span><span class="p">,</span> <span class="s2">&quot;s4_design_sim_tool&quot;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;SW_VERS&quot;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;NOI_VERS&quot;</span><span class="p">,</span> <span class="n">noise_version</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;SITE&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;SPLIT&quot;</span><span class="p">,</span> <span class="n">split</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;NSPLITS&quot;</span><span class="p">,</span> <span class="n">nsplits</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;CHANNEL&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())),</span>
                                <span class="p">(</span><span class="s2">&quot;CONFMD5&quot;</span><span class="p">,</span> <span class="n">md5sum_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span><span class="p">)),</span>
                            <span class="p">],</span>
                            <span class="n">coord</span><span class="o">=</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span>
                            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">hitmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">hitmap</span> <span class="o">/</span> <span class="n">nsplits</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

                        <span class="n">wcov_filename</span> <span class="o">=</span> <span class="n">output_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;KCMB&quot;</span><span class="p">,</span> <span class="s2">&quot;wcov&quot;</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing </span><span class="si">{</span><span class="n">wcov_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">hp</span><span class="o">.</span><span class="n">write_map</span><span class="p">(</span>
                            <span class="n">subfolder</span> <span class="o">/</span> <span class="n">wcov_filename</span><span class="p">,</span>
                            <span class="n">wcov</span><span class="p">,</span>
                            <span class="n">column_units</span><span class="o">=</span><span class="s2">&quot;K_CMB**2&quot;</span><span class="p">,</span>
                            <span class="n">extra_header</span><span class="o">=</span><span class="p">[</span>
                                <span class="p">(</span><span class="s2">&quot;SOFTWARE&quot;</span><span class="p">,</span> <span class="s2">&quot;s4_design_sim_tool&quot;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;SW_VERS&quot;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;NOI_VERS&quot;</span><span class="p">,</span> <span class="n">noise_version</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;SITE&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;SPLIT&quot;</span><span class="p">,</span> <span class="n">split</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;NSPLITS&quot;</span><span class="p">,</span> <span class="n">nsplits</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;CHANNEL&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())),</span>
                                <span class="p">(</span><span class="s2">&quot;CONFMD5&quot;</span><span class="p">,</span> <span class="n">md5sum_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span><span class="p">)),</span>
                            <span class="p">],</span>
                            <span class="n">coord</span><span class="o">=</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span>
                            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">wcov</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">ma</span><span class="p">(</span><span class="n">wcov</span><span class="p">)</span> <span class="o">*</span> <span class="n">nsplits</span>
                        <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">hitmap</span><span class="p">,</span> <span class="n">wcov</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="command_line_script" class="doc_header"><code>command_line_script</code><a href="https://github.com/cmb-s4/s4_design_sim_tool/tree/master/s4_design_sim_tool/cli.py#L209" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>command_line_script</code>(<strong><code>args</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">command_line_script</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">logging</span> <span class="k">as</span> <span class="nn">log</span>

    <span class="n">log</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">log</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run s4_design_sim_tool&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Configuration file&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--channels&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Channels e.g. all, SAT, LAT, LFL1 or comma separated list of channels&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--site&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Pole, Chile or all, default all&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output_folder&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output folder, optional&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">site</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Chile&quot;</span><span class="p">,</span> <span class="s2">&quot;Pole&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">site</span><span class="p">]</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">S4RefSimTool</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">output_folder</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">output_folder</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">sites</span><span class="o">=</span><span class="n">sites</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sim</span> <span class="o">=</span> <span class="n">S4RefSimTool</span><span class="p">(</span><span class="s2">&quot;s4_reference_design.toml&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">ls</span> /global/cscratch1/sd/keskital/s4sim/reference_tool/out/00000000/*atmo*
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">channels</span><span class="o">=</span><span class="s2">&quot;LFS1&quot;</span><span class="p">,</span> <span class="n">sites</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Pole&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">output_map</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">read_map</span><span class="p">(</span>
    <span class="s2">&quot;output/SAT-LFS1_pole/cmbs4_sky_atmosphere_noise_KCMB_SAT-LFS1_pole_nside512_1_of_1.fits&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="n">h</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">header</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">header_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">header</span><span class="p">}</span>
<span class="k">assert</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">&quot;SW_VERS&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">__version__</span>
<span class="k">assert</span> <span class="n">header_dict</span><span class="p">[</span><span class="s2">&quot;SOFTWARE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;s4_design_sim_tool&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">output_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hp</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">output_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hp</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-2</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-2</span><span class="p">,</span> \
    <span class="s2">&quot;Amplitude check failed&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1e-4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Total I&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1e-5</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Total Q&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hp</span><span class="o">.</span><span class="n">mollview</span><span class="p">(</span><span class="n">output_map</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">1e-5</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Total U&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

